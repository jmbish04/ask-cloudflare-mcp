<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ask Cloudflare MCP - Sessions</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); overflow: hidden; }
    header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
    h1 { font-size: 2.5rem; margin-bottom: 10px; }
    .subtitle { font-size: 1.1rem; opacity: 0.9; }
    .content { padding: 30px; }
    .loading { text-align: center; padding: 40px; font-size: 1.2rem; color: #666; }
    .session-list { display: grid; gap: 20px; }
    .session-card { border: 2px solid #e0e0e0; border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.3s ease; background: white; }
    .session-card:hover { border-color: #667eea; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2); transform: translateY(-2px); }
    .session-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; }
    .session-title { font-size: 1.3rem; font-weight: 600; color: #333; }
    .session-badge { padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; }
    .badge-simple-questions { background: #e3f2fd; color: #1976d2; }
    .badge-detailed-questions { background: #f3e5f5; color: #7b1fa2; }
    .badge-auto-analyze { background: #fff3e0; color: #f57c00; }
    .badge-pr-analyze { background: #e8f5e9; color: #388e3c; }
    .session-meta { display: flex; gap: 20px; font-size: 0.9rem; color: #666; margin-top: 8px; }
    .back-button { display: inline-block; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; margin-bottom: 20px; }
    .back-button:hover { background: #5568d3; }
    .detail-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 8px; margin-bottom: 30px; }
    .detail-title { font-size: 2rem; margin-bottom: 15px; }
    .download-button { display: inline-block; padding: 12px 24px; background: white; color: #667eea; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 600; margin-top: 20px; }
    .download-button:hover { background: #f0f0f0; transform: scale(1.05); }
    .section-title { font-size: 1.5rem; color: #333; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #667eea; }
    .question-card { border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 15px; background: #fafafa; }
    .question-text { font-size: 1.1rem; font-weight: 600; color: #333; margin-bottom: 10px; }
    .response-text { background: white; padding: 15px; border-radius: 6px; border-left: 4px solid #667eea; white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 0.9rem; max-height: 300px; overflow-y: auto; }
    .logs-toggle { display: flex; align-items: center; gap: 10px; padding: 15px; background: #f5f5f5; border-radius: 8px; cursor: pointer; }
    .logs-toggle:hover { background: #ebebeb; }
    .toggle-icon { font-size: 1.2rem; transition: transform 0.3s ease; }
    .toggle-icon.expanded { transform: rotate(90deg); }
    .error-indicator { display: inline-flex; padding: 4px 10px; background: #ffebee; color: #c62828; border-radius: 12px; font-size: 0.85rem; font-weight: 600; }
    .success-indicator { display: inline-flex; padding: 4px 10px; background: #e8f5e9; color: #2e7d32; border-radius: 12px; font-size: 0.85rem; font-weight: 600; }
    .logs-content { display: none; margin-top: 15px; max-height: 400px; overflow-y: auto; }
    .logs-content.expanded { display: block; }
    .log-entry { padding: 12px; margin-bottom: 8px; border-radius: 6px; border-left: 4px solid #ccc; }
    .log-entry.error { background: #ffebee; border-left-color: #c62828; }
    .log-entry.success { background: #f1f8f4; border-left-color: #2e7d32; }
    .empty-state { text-align: center; padding: 60px 20px; color: #999; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìä Ask Cloudflare MCP</h1>
      <p class="subtitle">Session Management Dashboard</p>
    </header>
    <div class="content">
      <div id="sessions-view">
        <div class="loading" id="sessions-loading">Loading sessions...</div>
        <div class="session-list" id="sessions-list" style="display: none;"></div>
        <div class="empty-state" id="empty-state" style="display: none;"><div style="font-size: 4rem; margin-bottom: 20px;">üì≠</div><p style="font-size: 1.2rem;">No sessions found</p></div>
      </div>
      <div id="session-detail" style="display: none;"></div>
    </div>
  </div>
  <script>
    const API_BASE = window.location.origin + '/api';
    function showSessionsList() { document.getElementById('sessions-view').style.display = 'block'; document.getElementById('session-detail').style.display = 'none'; loadSessions(); }
    function showSessionDetail(sessionId) { document.getElementById('sessions-view').style.display = 'none'; document.getElementById('session-detail').style.display = 'block'; loadSessionDetail(sessionId); }
    async function loadSessions() {
      const loading = document.getElementById('sessions-loading'), list = document.getElementById('sessions-list'), empty = document.getElementById('empty-state');
      loading.style.display = 'block'; list.style.display = 'none'; empty.style.display = 'none';
      try {
        const response = await fetch(`${API_BASE}/sessions?limit=100`), data = await response.json();
        loading.style.display = 'none';
        if (data.sessions && data.sessions.length > 0) { list.style.display = 'grid'; list.innerHTML = data.sessions.map(s => `<div class="session-card" onclick="showSessionDetail('${s.session_id}')"><div class="session-header"><div class="session-title">${s.title || 'Untitled Session'}</div><div class="session-badge badge-${s.endpoint_type}">${s.endpoint_type}</div></div><div class="session-meta"><span>üïí ${new Date(s.timestamp).toLocaleString()}</span>${s.repo_url ? `<span>üì¶ ${s.repo_url}</span>` : ''}</div></div>`).join(''); } else { empty.style.display = 'block'; }
      } catch (error) { loading.textContent = 'Error loading sessions: ' + error.message; }
    }
    async function loadSessionDetail(sessionId) {
      const container = document.getElementById('session-detail');
      container.innerHTML = '<div class="loading">Loading session details...</div>';
      try {
        const response = await fetch(`${API_BASE}/sessions/${sessionId}`), data = await response.json();
        if (data.error) { container.innerHTML = `<div class="error">${data.error}</div>`; return; }
        const {session, questions, action_logs} = data, errorCount = action_logs.filter(log => log.has_error).length;
        container.innerHTML = `<button class="back-button" onclick="showSessionsList()">‚Üê Back to Sessions</button><div class="detail-header"><div class="detail-title">${session.title || 'Untitled Session'}</div><button class="download-button" onclick="downloadSession('${session.session_id}')">‚¨áÔ∏è Download JSON</button></div><div><h2 class="section-title">Questions & Responses</h2>${questions.length > 0 ? questions.map(q => `<div class="question-card"><div class="question-text">‚ùì ${q.question}</div><div class="response-text">${JSON.stringify(JSON.parse(q.response), null, 2)}</div></div>`).join('') : '<p>No questions found.</p>'}</div><div style="margin-top: 30px;"><div class="logs-toggle" onclick="toggleLogs()"><span class="toggle-icon" id="logs-toggle-icon">‚ñ∂</span><h2 class="section-title" style="margin: 0; border: none;">Action Logs</h2>${errorCount > 0 ? `<span class="error-indicator">‚ö†Ô∏è ${errorCount} error${errorCount > 1 ? 's' : ''}</span>` : `<span class="success-indicator">‚úì All clear</span>`}</div><div class="logs-content" id="logs-content">${action_logs.length > 0 ? action_logs.map(log => `<div class="log-entry ${log.has_error ? 'error' : 'success'}"><div style="display: flex; justify-content: space-between; margin-bottom: 5px;"><span style="font-weight: 600;">${log.action_type}</span><span style="font-size: 0.85rem; color: #666;">${new Date(log.timestamp).toLocaleString()}</span></div><div style="font-size: 0.9rem; color: #555;">${log.action_description}</div>${log.has_error && log.error_message ? `<div style="margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.05); border-radius: 4px; font-size: 0.85rem; color: #c62828;">${log.error_message}</div>` : ''}</div>`).join('') : '<p>No logs found.</p>'}</div></div>`;
      } catch (error) { container.innerHTML = `<div class="error">Error loading session: ${error.message}</div>`; }
    }
    function toggleLogs() { document.getElementById('logs-content').classList.toggle('expanded'); document.getElementById('logs-toggle-icon').classList.toggle('expanded'); }
    async function downloadSession(sessionId) {
      try {
        const response = await fetch(`${API_BASE}/sessions/${sessionId}/download`), data = await response.json(), blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'}), url = URL.createObjectURL(blob), a = document.createElement('a');
        a.href = url; a.download = `session-${sessionId}.json`; a.click(); URL.revokeObjectURL(url);
      } catch (error) { alert('Error downloading session: ' + error.message); }
    }
    loadSessions();
  </script>
</body>
</html>
